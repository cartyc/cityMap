{% load static %}

<!DOCTYPE html>

<html>

<head>

	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<title>Property Search</title>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.3/css/bootstrap.min.css" integrity="	sha384-MIwDKRSSImVFAZCVLtU0LMDdON6KVCrZHyVQQj6e8wIEJkW4tvwqXrbMIya1vriY" crossorigin="anonymous">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js" integrity="sha384-THPy051/pYDQGanwU6poAc/hOdQxjnOEXzbT+OuUAFqNqFjL+4IGLBgCJC3ZOShY" crossorigin="anonymous"></script>

	<script src="http://cdnjs.cloudflare.com/ajax/libs/tether/1.2.0/js/tether.min.js" integrity="sha384-Plbmg8JY28KFelvJVai01l8WyZzrYWG825m+cZ0eDDS1f7d/js6ikvy1+X+guPIB" crossorigin="anonymous"></script>
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.3/js/bootstrap.min.js" integrity="sha384-ux8v3A6CPtOTqOzMKiuo3d/DomGaaClxFYdCu2HPMBEkf6x2xiDyJ7gkXU0MWwaD" crossorigin="anonymous"></script>
	<link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">


	<!-- Leaftlet -->
	<!-- Load Leaflet from CDN-->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>

	<!-- Load Esri Leaflet from CDN -->
	<script src="https://cdn.jsdelivr.net/leaflet.esri/2.0.0/esri-leaflet.js"></script>

	{# font awesome markers #}
	<link rel="stylesheet" href="{% static "css/leaflet.awesome-markers.css" %}">

	<script src="{% static "js/leaflet.awesome-markers.min.js" %}"></script>


	<!-- ESRI GeoCoder -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/leaflet.esri.geocoder/2.1.0/esri-leaflet-geocoder.css">
	<script src="https://cdn.jsdelivr.net/leaflet.esri.geocoder/2.1.0/esri-leaflet-geocoder.js"></script>

	<!-- Proj4js  -->
	<!-- For converting coords -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.14/proj4-src.js"></script>

	{# Box Zoom #}
	<link rel="stylesheet" href="{% static "css/L.Control.ZoomBox.css" %}">
	<script src="{% static "js/L.Control.ZoomBox.min.js" %}"></script>

	{# Self style #}
	<link rel="stylesheet" href="{% static "css/main.css" %}">


	{# Grouped layers #}
	<link rel="stylesheet" href="{% static "css/leaflet.groupedlayercontrol.min.css" %}">
	<script src='{% static "js/leaflet.groupedlayercontrol.min.js" %}'></script>
<body>
	
	<nav class="navbar navbar-full navbar-dark bg-faded" style="background-color: #083D77">
		<a href="" class="navbar-brand">
			Property Search
		</a>

		<form id="parcelSearch" action="" method="GET" class="form-inline pull-right">
			<div class="input-group">
				<input type="text" name="address_name" id="address_name" placeholder="Search Address/Pin..." class="form-control">		
				<span class="input-group-btn">
					<button class="btn btn-primary" type="submit">
						<i id="search-button" class="fa fa-search" aria-hidden="true"></i>
					</button>
				</span>
			</div>
		</form>
	</nav>

	<main>

		<div class="container-fluid">
			<div class="row">
				<div id="result-container" class="hidden container">
					<div id="results"></div>
				</div>
				<div id="map-container" class="col-md-12">
					<div id="map"></div>				
				</div>
			</div>			
		</div>


	</main>

	{# Modal #}
	<div class="modal" id="property-data" role="dialog" aria-labelledby="propertyData" aria-hidden="true">
			<div class="modal-dialog modal-lg" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						<h4 class="modal-title"></h4>
					</div>
					<div class="modal-body"></div>
				</div>
			</div>
	</div>

	<footer>
		
	</footer>

	<script src="{% static "js/system.js" %}"></script>

	<script>

		function wardLookUp(coords){
			// Identiify propery ward location
			var coords = coords.x + "," + coords.y;

			var url = "http://maps.ottawa.ca/arcgis/rest/services/Wards/MapServer/0/query?where=&text=&objectIds=&time=&geometry=" + coords + "&geometryType=esriGeometryPoint&inSR=&spatialRel=esriSpatialRelWithin&relationParam=&outFields=&returnGeometry=true&returnTrueCurves=false&maxAllowableOffset=&geometryPrecision=&outSR=&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&returnDistinctValues=false&resultOffset=&resultRecordCount=&f=pjson"

			var results = query(url)

			return results
		}


		function neighbourhoodLookUp(coords){
			// Identiify propery ward location
			var coords = coords.x + "," + coords.y;

			var url = "http://maps.ottawa.ca/arcgis/rest/services/Neighbourhoods/MapServer/1/query?where=&text=&objectIds=&time=&geometry=" + coords + "&geometryType=esriGeometryPoint&inSR=&spatialRel=esriSpatialRelWithin&relationParam=&outFields=&returnGeometry=true&returnTrueCurves=false&maxAllowableOffset=&geometryPrecision=&outSR=&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&returnDistinctValues=false&resultOffset=&resultRecordCount=&f=pjson"

			var results = query(url)

			return results
		}

		function localHospitals(coords){
			// Find nearest hospital to location
			var coords = coords.x + " " + coords.y;

			var url = "http://maps.ottawa.ca/arcgis/rest/services/Hospitals/MapServer/0/query?where=&text=&objectIds=&time=&geometry="+ coords +"&geometryType=esriGeometryPoint&inSR=&spatialRel=esriSpatialRelRelation&relationParam=near&outFields=&returnGeometry=true&returnTrueCurves=false&maxAllowableOffset=&geometryPrecision=&outSR=&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&returnDistinctValues=false&resultOffset=&resultRecordCount=&f=pjson"

			console.log(url)

			var results = query(url);

			return results;
		}

		function propertyTrees(geom){

			var url = "http://maps.ottawa.ca/arcgis/rest/services/Miscellaneous/MapServer/1/query?where=&text=&objectIds=&time=&geometry="+ geom.rings+"&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelContains&relationParam=&outFields=SPECIES&returnGeometry=true&returnTrueCurves=false&maxAllowableOffset=&geometryPrecision=&outSR=&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&returnDistinctValues=false&resultOffset=&resultRecordCount=&f=pjson";

			var results = query(url)

			return results
		}

		function propertyModal(id){

			// Create Property Detail PopUp from select result

			var url = "http://maps.ottawa.ca/arcgis/rest/services/Property_Parcels/MapServer/0/query?where=OBJECTID%3D" +id +"&text=&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&relationParam=&outFields=FULLADDR%2C+POINTTYPE%2C+WARD%2C+OBJECTID&returnGeometry=true&returnTrueCurves=false&maxAllowableOffset=&geometryPrecision=&outSR=&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&returnDistinctValues=false&resultOffset=&resultRecordCount=&f=pjson"


			property = query(url);
			point = property[0].geometry

			ward = wardLookUp(point);
			// hospitals = localHospitals(point);

			var zoning = zoningLookUp(property[0].geometry.x, property[0].geometry.y ),
			pin = pinGeoLookUp(property[0].geometry.x, property[0].geometry.y),
			schoolDistrict = "School District",
			trees = propertyTrees(pin[0].geometry),
			neighbourhood = neighbourhoodLookUp(point);

			var treeNames = []
			if (trees){
				for (var i = 0; i < trees.length; i++){
					treeNames.push(trees[i].attributes.SPECIES);
				}
			}

			// Change Title and clear body
			$(".modal-title").html(property[0].attributes.FULLADDR + " <small class='text-muted'>" + neighbourhood[0].attributes.NAMES + "</small>");
			$(".modal-body").empty();

			// for ( var i = 0; i < hospitals.length; i++){
			// 	var hospital = hospitals[i].attributes.NAME;
			// 	$(".modal-body").append("<p>" + hospital + "</p>");
			// }

			// Put Results of search into body
			var body = "\
			<div class='row'>\
				<div class='col-md-4'>Parcel Area</div><div class='col-md-8'>"+ pin[0].attributes.Shape_Area.toLocaleString() + " m2</div>\
			</div>\
			<div class='row'>\
				<div class='col-md-4'>Zoning</div><div class='col-md-8'>"+ zoning.ZONE_CODE + " <a href='http://www.ottawa.ca" + zoning.URL + "' target='_blank'>Reference</a></div>\
			</div>\
			<div class='row'>\
				<div class='col-md-4'>School District</div><div class='col-md-8'>"+ schoolDistrict + "</div>\
			</div>\
			<div class='row'>\
				<div class='col-md-4'>Tree's On Property</div><div class='col-md-8'>"+ treeNames + "</div>\
			</div>"

			$(".modal-body").append(body);

			$('#property-data').modal('toggle')

		}

	</script>

</body>

</html>

				